<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KSC Wiedikon H3 Ranking and Results</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');

    body {
      font-family: 'Segoe UI', Aptos, sans-serif;
      margin: 20px;
      background-color: #f8f9fa;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      margin-top: 40px;
      font-size: 1.5em;
      color: #444;
    }

    .table-wrapper {
      max-width: 100%;
      margin: 0 auto;
    }

    table.dataTable {
      width: 100% !important;
      font-size: 12px;
      table-layout: auto;
      border-collapse: collapse;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      word-break: break-word;
    }

    #rankings td:first-child {
      font-weight: bold;
      white-space: normal;
    }

    .wiedikon-team {
      font-weight: bold;
    }

    .error-message {
      color: red;
      background-color: #ffe6e6;
      padding: 10px;
      border: 1px solid #ff9999;
      border-radius: 4px;
      margin: 10px 0;
    }

    @media screen and (max-width: 768px) {
      html, body {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <h1>KSC Wiedikon H3 Ranking and Results</h1>

  <h2>Rankings</h2>
  <div class="table-wrapper">
    <table id="rankings" class="display"></table>
  </div>

  <h2>Results</h2>
  <div class="table-wrapper">
    <div id="results-error" style="display: none;" class="error-message"></div>
    <table id="results" class="display"></table>
  </div>

  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    function formatDate(dateStr) {
      if (!dateStr) return "";
      
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Return original if invalid date
        
        const pad = (n) => n.toString().padStart(2, "0");

        const day = pad(date.getDate());
        const month = pad(date.getMonth() + 1);
        const year = date.getFullYear();
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());

        return `${day}/${month}/${year}<br>${hours}:${minutes}`;
      } catch (error) {
        console.error("Error formatting date:", dateStr, error);
        return dateStr;
      }
    }

    $(async function () {
      const RANKINGS_API = "https://volley-rankings-849246684371.europe-west6.run.app";
      const RESULTS_API = "https://volley-results-849246684371.europe-west6.run.app";
      const TEAM_ID = 12747;

      try {
        // Rankings
        console.log("Fetching rankings...");
        const r = await fetch(`${RANKINGS_API}/rankings?team_id=${TEAM_ID}`);
        if (!r.ok) {
          throw new Error(`Rankings API error: ${r.status} ${r.statusText}`);
        }
        const rankingData = await r.json();
        console.log("Rankings data:", rankingData);

        $("#rankings").DataTable({
          data: rankingData,
          columns: [
            { data: "rank",         title: "Rank", width: "8%" },
            { data: "team_name",    title: "Team", width: "auto" },
            { data: "points",       title: "Pts", width: "8%" },
            { data: "games_played", title: "# Matches", width: "8%" },
            { data: "wins",         title: "Matches won", width: "8%" },
            { data: "defeats",      title: "Matches lost", width: "8%" },
            { data: "sets_won",     title: "Sets won", width: "8%" },
            { data: "sets_lost",    title: "Sets lost", width: "8%" },
            { data: "balls_won",    title: "Balls won", width: "8%" },
            { data: "balls_lost",   title: "Balls lost", width: "8%" }
          ],
          createdRow: function (row, data) {
            if (data.team_name && data.team_name.includes("Wiedikon")) {
              $(row).addClass("wiedikon-team");
            }
          },
          paging: false,
          ordering: false,
          info: false,
          searching: false
        });

        // Results
        console.log("Fetching results...");
        const q = await fetch(`${RESULTS_API}/results?team_id=${TEAM_ID}`);
        if (!q.ok) {
          throw new Error(`Results API error: ${q.status} ${q.statusText}`);
        }
        const resultsData = await q.json();
        console.log("Results data:", resultsData);

        if (!Array.isArray(resultsData) || resultsData.length === 0) {
          $("#results-error").text("No results data available").show();
          return;
        }

        const resultsTable = $("#results").DataTable({
          data: resultsData,
          columns: [
            {
              data: "play_date",
              title: "Date",
              render: function(data, type, row) {
                if (type === 'display') {
                  return formatDate(data);
                }
                return data;
              }
            },
            {
              title: "Match",
              data: null,
              render: function(data, type, row) {
                const result = row.result || "";
                let home = row.home || "";
                let away = row.away || "";
                
                // Make Wiedikon team bold
                if (home.includes("Wiedikon")) {
                  home = `<strong>${home}</strong>`;
                }
                if (away.includes("Wiedikon")) {
                  away = `<strong>${away}</strong>`;
                }
                
                // Only try to split if result is a string
                if (typeof result === 'string' && result.includes(":")) {
                  const [homeSets, awaySets] = result.split(":").map(n => parseInt(n));
                  
                  if (!isNaN(homeSets) && !isNaN(awaySets)) {
                    if (homeSets > awaySets) home += " üèÜ";
                    else if (awaySets > homeSets) away += " üèÜ";
                  }
                }

                return `${home} - ${away}`;
              }
            },
            {
              title: "Home/Away",
              data: null,
              render: function(data, type, row) {
                return (row.home && row.home.includes("Wiedikon")) ? "Home" : "Away";
              }
            },
            { data: "halle",     title: "Halle"     },
            { data: "city",      title: "City"      },
            { data: "plus_code", title: "Plus Code" },
            { data: "referees",  title: "Referee(s)" },
            { data: "result",    title: "Result" }
          ],
          createdRow: function (row, data) {
            const isHome = data.home && data.home.includes("Wiedikon");
            const wiedikonInvolved = (data.home && data.home.includes("Wiedikon")) || 
                                   (data.away && data.away.includes("Wiedikon"));

            if (wiedikonInvolved) {
              if (isHome) {
                // Full row bold for home games
                $(row).addClass("wiedikon-team");
              }
              // For away games, only the team name is bold (handled in the render function)
            }
          },
          paging: false,
          ordering: false,
          info: false,
          searching: false
        });

        console.log("Results table initialized successfully");

      } catch (error) {
        console.error("Error loading data:", error);
        $("#results-error").text(`Error loading data: ${error.message}`).show();
      }
    });
  </script>
</body>
</html>
