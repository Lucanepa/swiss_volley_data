<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<title>KSC Wiedikon Volleyball</title>

<style>
    /* ============ ORIGINAL STYLES (unchanged) ============ */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#1a202c;line-height:1.6}
    .container{max-width:100%;margin:0 auto;padding:2px;min-height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center}
    .content-section{background:#fff;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);margin-bottom:20px;width:100%;overflow:hidden}
    .content-section h2{background:linear-gradient(135deg,#0066CC 0%,#FFD700 100%);color:#fff;padding:12px 16px;font-size:1.25rem;font-weight:600;margin:0}
    .sub-section{margin:5px}
    .sub-section h3{background:linear-gradient(135deg,#0066CC 0%,#FFD700 100%);color:#fff;padding:10px 14px;margin:0 0 10px;border-radius:8px;font-size:1rem;font-weight:600}
    .table-wrapper{width:100%;overflow-x:hidden}
    .table-wrapper table{width:100%!important;table-layout:fixed!important;word-break:normal}
    .table-wrapper table td, .table-wrapper table th{padding:2px 5px!important}
    
    @media (max-width: 768px) {
      .table-wrapper table {
        table-layout: auto !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Rankings table specific mobile styling */
      #rankings-container .table-wrapper {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      #rankings-container .table-wrapper table {
        table-layout: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        min-width: auto !important;
      }
      
      /* Ensure rankings table doesn't overflow */
      #rankings-container .dataTables_wrapper {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scroll {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scrollBody {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      /* Force DataTables to respect mobile constraints */
      #rankings-container .dataTables_wrapper .dataTables_scrollHead {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scrollHead table {
        width: 100% !important;
        max-width: 100% !important;
        table-layout: auto !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scrollBody table {
        width: 100% !important;
        max-width: 100% !important;
        table-layout: auto !important;
      }
      
      /* Additional mobile constraints */
      #rankings-container {
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      #rankings-container * {
        max-width: 100vw !important;
      }
      
      /* Force DataTables to behave on mobile */
      #rankings-container .dataTables_wrapper {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scroll {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scrollBody {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      #rankings-container .dataTables_wrapper .dataTables_scrollHead {
        width: 100% !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      
      /* Force table cells to wrap and not overflow */
      #rankings-container .dataTables_wrapper .dataTables_scrollBody td {
        max-width: 0 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
      }
      
      /* Allow team names to wrap on mobile */
      #rankings-container .dataTables_wrapper .dataTables_scrollBody td:nth-child(2) {
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* Nuclear option - force everything to fit */
      #rankings-container .dataTables_wrapper,
      #rankings-container .dataTables_wrapper *,
      #rankings-container .table-wrapper,
      #rankings-container .table-wrapper * {
        max-width: 100vw !important;
        box-sizing: border-box !important;
      }
      
      /* Ensure table doesn't exceed viewport */
      #rankings-container table {
        width: 100% !important;
        max-width: 100vw !important;
        table-layout: auto !important;
      }
    }

    .dataTables_wrapper .dataTables_scroll {
      overflow-x: hidden !important;
    }

    .dataTables_wrapper .dataTables_scrollBody {
      overflow-x: hidden !important;
      padding: 1px 2px !important;
      font-size: 12px;
    }

    /* Mobile font size adjustments */
    @media (max-width: 768px) {
      .dataTables_wrapper .dataTables_scrollBody {
        font-size: 11px !important;
      }
      
      .dataTables_wrapper .dataTables_scrollHead th {
        font-size: 11px !important;
      }
      
      .dataTables_wrapper .dataTables_scrollBody td {
        font-size: 11px !important;
      }
      
      .sub-section h3 {
        font-size: 0.9rem;
      }
      
      .content-section h2 {
        font-size: 1.1rem;
      }
    }

    /* Results table specific styling - automatic height */
    #results-container .table-wrapper {
      height: auto;
      overflow-y: visible;
    }

    #results-container .dataTables_wrapper .dataTables_scrollBody {
      height: auto;
      overflow-y: visible !important;
    }

    /* Freeze headers when scrolling */
    .dataTables_wrapper .dataTables_scrollHead {
      position: sticky !important;
      top: 0 !important;
      z-index: 10 !important;
      background: white !important;
    }

    /* Ensure sticky headers work in results table */
    #results-container .dataTables_wrapper .dataTables_scrollHead {
      position: sticky !important;
      top: 0 !important;
      z-index: 10 !important;
      background: white !important;
    }

    /* Center emojis in headers */
    .dataTables_wrapper .dataTables_scrollHead th {
      text-align: center !important;
    }

    .dataTables_wrapper .dataTables_scrollHead th {
      font-size: 12px !important;
      padding: 4px 2px !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dataTables_wrapper .dataTables_scrollBody td {
      padding: 2px 2px !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dataTables_wrapper .dataTables_scrollBody td:nth-child(3) {
      white-space: normal !important;
      word-break: break-word !important;
      overflow-wrap: break-word;
      min-width: 150px;
    }

    /* Results table specific styling - match column wrapping */
    @media (max-width: 768px) {
      /* Only apply to results table */
      #results-container .dataTables_wrapper .dataTables_scrollBody td:nth-child(3) {
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        min-width: 120px !important;
        max-width: 180px !important;
        padding: 4px 2px !important;
        font-size: 10px !important;
        line-height: 1.2 !important;
      }
      
      /* Ensure results table doesn't overflow */
      #results-container .table-wrapper {
        overflow-x: hidden !important;
      }
      
      /* Allow results table to be responsive */
      #results-container .table-wrapper table {
        table-layout: auto !important;
        width: 100% !important;
        max-width: 100% !important;
      }
    }
    
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
      display: none !important;
    }

    /* Detail view styles */
    .detail-view {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .detail-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin: 120px auto 20px auto;
      padding: 24px;
      width: 90%;
      max-width: 800px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }

    .detail-content h2 {
      background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
      color: white;
      padding: 20px 24px;
      margin: -24px -24px 24px -24px;
      border-radius: 12px 12px 0 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .detail-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .detail-table th,
    .detail-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .detail-table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #374151;
      width: 30%;
    }

    .detail-close {
      background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .detail-close:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Modal styles - CENTERED */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      margin: 0 auto;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      top: 0;
      transform: none;
    }

    .modal-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .modal-table th,
    .modal-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    /* Error message styles */
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    /* Loading styles */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #374151;
      font-size: 16px;
    }

    /* Loading progress styles */
    .loading-container {
      text-align: center;
      padding: 40px 20px;
    }

    .loading-text {
      font-size: 16px;
      color: #374151;
      margin-bottom: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Clickable row styles */
    .clickable-row {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .clickable-row:hover {
      background-color: #f0f9ff !important;
    }

    .last-updated,
    .updated-at {
      text-align: center;
      color: #6b7280;
      font-size: 12px;
      margin-top: 20px;
      font-style: italic;
    }

    /* Next Game three-row layout styles */
    .next-game-simple {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .next-game-row {
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
    }

    .next-game-row > div {
      padding: 12px 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      min-width: 200px;
    }

    .next-game-details-btn {
      background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      align-self: center;
      margin-top: 10px;
    }

    .next-game-details-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* Responsive design for next game */
    @media (max-width: 768px) {
      .next-game-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .next-game-row > div {
        min-width: auto;
        width: 100%;
      }
    }
</style>
</head>
<body>

<div id="results" class="container">
  <!-- ===== NEXT GAME (with loader) ===== -->
  <div id="next-game-section" class="content-section">
    <h2>Next Game</h2>
    <div id="next-game-container">
      <div class="loading-container">
        <div class="loading-text">Loading next game&hellip;</div>
        <div class="progress-bar">
          <div class="progress-fill" id="next-game-progress-fill"></div>
        </div>
        <div class="progress-text" id="next-game-progress-text">0%</div>
      </div>
    </div>
  </div>

  <!-- ===== RANKINGS ===== -->
  <div class="content-section">
    <h2>Rankings</h2>
    <div id="rankings-container">
      <div class="loading-container">
        <div class="loading-text">Loading rankings data&hellip;</div>
        <div class="progress-bar">
          <div class="progress-fill" id="rankings-progress-fill"></div>
        </div>
        <div class="progress-text" id="rankings-progress-text">0%</div>
      </div>
    </div>
  </div>

  <!-- ===== RESULTS ===== -->
  <div class="content-section">
    <h2>Results</h2>
    <div id="results-container">
      <div class="loading-container">
        <div class="loading-text">Loading results data&hellip;</div>
        <div class="progress-bar">
          <div class="progress-fill" id="results-progress-fill"></div>
        </div>
        <div class="progress-text" id="results-progress-text">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- Detail view + modal markup -->
<div id="detail-view" class="detail-view">
  <div id="detail-content" class="detail-content"></div>
</div>

<div id="dataModal" class="modal">
  <div class="modal-content">
    <div id="modalContent"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- CONFIG ---------- */
// Supabase configuration
const SUPABASE_URL = 'https://wilrrlwqgvzjdhmnwmte.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_smrIIJd_DJofe68QRJmB1w_qiASLbqE';

// Initialize Supabase client
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- HELPERS ---------- */
function pad(n){return n.toString().padStart(2,"0")}
function formatDate(d){const t=new Date(d);return isNaN(t)?"":`${pad(t.getDate())}.${pad(t.getMonth()+1)}.${String(t.getFullYear()).slice(-2)}`}
function formatTime(d){const t=new Date(d);return isNaN(t)?"":`${pad(t.getHours())}:${pad(t.getMinutes())}`}
function formatDateWithDay(d){const t=new Date(d);const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];return isNaN(t)?"":`${days[t.getDay()]} ${formatDate(d)}`}
function cleanTeamName(n,r=false){if(!n)return"";let c=n.replace(/KSC\s+Wiedikon/g,"KSCW");if(r)c=c.replace(/KSCW\s+/g,"");return c.replace(/^(VBC|VC|Volley|Volleyball)\s+/i,"").replace(/\s+(VBC|VC|Volley|Volleyball)$/i,"").trim()}
function leagueOrGroup(row){return row.league_caption&&row.league_caption.toLowerCase().includes("cup")?row.league_caption:(row.group_caption||"Unknown League");}

/* ---------- RENDER NEXT GAME (THREE ROWS) ---------- */
function renderNextGame(g){
  const date = formatDateWithDay(g.play_date),
        time = formatTime(g.play_date),
        home = cleanTeamName(g.teams_home_caption, true),
        away = cleanTeamName(g.teams_away_caption, true),
        league = g.league_caption || "Unknown League",
        isCup = league.toLowerCase().includes("cup"),
        leagueIcon = isCup ? "🏆" : "🎖️";
  
  return `<div class="next-game-simple">
            <div class="next-game-row">
              <div><strong>📅</strong>${date} <strong>🕒</strong>${time}</div>
            </div>
            <div class="next-game-row">
              <div><strong>⚔️</strong>${home} – ${away}</div>
            </div>
            <div class="next-game-row">
              <div><strong>${leagueIcon}</strong>${league}</div>
            </div>
            <button class="next-game-details-btn" data-game-id="${g.wiedikon_team_id}" data-game-date="${g.play_date}">
              Click for more details
            </button>
          </div>`;
}

/* ---------- SHOW NEXT GAME DETAILS ---------- */
function showNextGameDetails(game) {
  const modalContent = `
    <h2>Next Game Details</h2>
    <table class="modal-table">
      <tr><th>Date</th><td>${formatDateWithDay(game.play_date)} ${formatTime(game.play_date)}</td></tr>
      <tr><th>Home Team</th><td>${game.teams_home_caption || 'N/A'}</td></tr>
      <tr><th>Away Team</th><td>${game.teams_away_caption || 'N/A'}</td></tr>
      <tr><th>League</th><td>${game.league_caption || 'N/A'}</td></tr>
      <tr><th>Group</th><td>${game.group_caption || 'N/A'}</td></tr>
      <tr><th>Phase</th><td>${game.phase_caption || 'N/A'}</td></tr>
      <tr><th>Hall</th><td>${game.hall_caption || 'N/A'}</td></tr>
      <tr><th>Address</th><td>${[game.hall_street, game.hall_number, game.hall_city, game.hall_zip].filter(Boolean).join(' ') || 'N/A'}</td></tr>
      <tr><th>Maps</th><td>${game.hall_plus_code ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(game.hall_plus_code.trim().replace(/\s+/g, "+"))}" target="_blank">Open in Google Maps</a>` : 'N/A'}</td></tr>
      <tr><th>Referees</th><td>${game.referee_1 || 'N/A'}${game.referee_2 ? ', ' + game.referee_2 : ''}</td></tr>
      <tr><th>Game ID</th><td>${game.game_id || 'N/A'}</td></tr>
    </table>
    <button class="detail-close" onclick="closeModal()">Close</button>
  `;
  
  $("#modalContent").html(modalContent);
  $("#dataModal").show();
}

/* ---------- TEAM MAPS (unchanged) ---------- */
const teamNames={"12747":"KSC Wiedikon H3","1394":"KSC Wiedikon D4","14040":"KSC Wiedikon DU23-2","7563":"KSC Wiedikon HU23-1","1393":"KSC Wiedikon D2","541":"KSC Wiedikon H2","6023":"KSC Wiedikon Legends","4689":"KSC Wiedikon D3","2743":"KSC Wiedikon H1","1395":"KSC Wiedikon D1","2301":"KSC Wiedikon DU23-1"};
const slugToId ={"h3":"12747","d4":"1394","du20":"14040","hu23":"7563","d2":"1393","h2":"541","hl":"6023","d3":"4689","h1":"2743","d1":"1395","du23":"2301"};

/* ---------- DataTables cleanup ---------- */
function destroyTables(sel){$(sel).find("table.dataTable").each(function(){if($.fn.DataTable.isDataTable(this))$(this).DataTable().destroy();});}

/* ---------- MAIN LOADER ---------- */
async function loadData(teamId){
  console.log('loadData called with teamId:', teamId, 'type:', typeof teamId);
  
  // Ensure teamId is a string (Supabase expects string for .eq())
  if (typeof teamId === 'number') {
    teamId = teamId.toString();
  }
  
  /* Loader progress */
  let done=0,total=2;
  const prog=p=>{done++;const pct=Math.round(done/total*100);
     if(p==="rank"){ $("#rankings-progress-fill").css("width",pct+"%");$("#rankings-progress-text").text(pct+"%"); }
     if(p==="results"){
        $("#results-progress-fill").css("width",pct+"%");$("#results-progress-text").text(pct+"%");
        $("#next-game-progress-fill").css("width",pct+"%");$("#next-game-progress-text").text(pct+"%");
     }
  };

  try {
    // Query rankings_complete view directly from Supabase
    const { data: rankData, error: rankError } = await supabaseClient
      .from('rankings_complete')
      .select('*')
      .eq('wiedikon_team_id', teamId);
    
    if (rankError) {
      console.error('Error fetching rankings:', rankError);
      $("#rankings-container").html('<div class="error-message">Rankings error: ' + rankError.message + '</div>');
      return;
    }
    
    prog("rank");

    // Query games_complete view directly from Supabase
    const { data: resData, error: resError } = await supabaseClient
      .from('games_complete')
      .select('*')
      .eq('wiedikon_team_id', teamId);
    
    if (resError) {
      console.error('Error fetching games:', resError);
      $("#results-container").html('<div class="error-message">Games error: ' + resError.message + '</div>');
      return;
    }
    
    prog("results");

  /* ---------- NEXT GAME ----------- */
  const next=resData.filter(g=>new Date(g.play_date)>new Date())
                    .sort((a,b)=>new Date(a.play_date)-new Date(b.play_date))[0];
  if(next){
    $("#next-game-container").html(renderNextGame(next));
    
    // Add click handler for the next game details button
    $("#next-game-container .next-game-details-btn").on('click', function() {
      // Find the game data from the resData array using the button's data attributes
      const button = $(this);
      const teamId = button.data('game-id');
      const gameDate = button.data('game-date');
      
      // Find the matching game in resData
      const gameData = resData.find(g => 
        g.wiedikon_team_id == teamId && 
        g.play_date === gameDate
      );
      
      if (gameData) {
        showNextGameDetails(gameData);
      }
    });
  }else{
    $("#next-game-container").html('<div class="error-message">No upcoming games found.</div>');
  }

  /* ---------- RENDER RANKINGS (filter out cup competitions) ---------- */
  destroyTables("#rankings-container");$("#rankings-container").empty();
  
  // Filter out cup competitions and group by league/group
  const rBy={};
  rankData.forEach(r => {
    // Skip if this is a cup competition
    if (r.league_caption && r.league_caption.toLowerCase().includes("cup")) {
      return; // Skip this ranking
    }
    
    // Use group_caption for regular leagues
    const groupKey = r.group_caption || "Unknown League";
    if (!rBy[groupKey]) rBy[groupKey] = [];
    rBy[groupKey].push(r);
  });
     for(const lg in rBy){
     $("#rankings-container").append(`<div class="sub-section"><h3>${lg}</h3></div>`);
     const $w=$(`<div class="table-wrapper"><table class="display"></table></div>`).appendTo("#rankings-container");
     $w.find("table").DataTable({
       data:rBy[lg],
       columns:[
         {data:"rank",title:"🎖️",width:"8%"},
         {data:"teamcaption",title:"Team",width:"42%",render:(d,t)=>t==="display"?cleanTeamName(d):d},
         {data:"points",title:"Pts",width:"12%"},
         {data:"games",title:"#️⃣",width:"12%"},
         {data:"wins",title:"🏆",width:"13%"},
         {data:"defeats",title:"💔",width:"13%"}
       ],
       paging:false,searching:false,ordering:false,info:false,autoWidth:false,deferRender:true,
       createdRow: (row, data) => {
         // Highlight KSC Wiedikon teams in light blue and bold
         if (data.teamcaption && data.teamcaption.toLowerCase().includes("wiedikon")) {
           $(row).find("td").css({
             "background-color": "#e6f3ff",
             "font-weight": "bold"
           });
         }
       }
     });
     
     // Add click handlers for modal
     $w.find("table tbody tr").addClass("clickable-row").click(function() {
       const data = $w.find("table").DataTable().row(this).data();
       showRankingModal(data);
     });
   }

  /* ---------- RENDER RESULTS ---------- */
  destroyTables("#results-container");$("#results-container").empty();
  const resBy={};resData.forEach(r=>(resBy[leagueOrGroup(r)]??=[]).push(r));
  
  // Sort leagues: cup first, then normal leagues
  const sortedLeagues = Object.keys(resBy).sort((a, b) => {
    const aIsCup = a.toLowerCase().includes("cup");
    const bIsCup = b.toLowerCase().includes("cup");
    if (aIsCup && !bIsCup) return -1;
    if (!aIsCup && bIsCup) return 1;
    return a.localeCompare(b);
  });
  
  for(const lg of sortedLeagues){
    $("#results-container").append(`<div class="sub-section"><h3>${lg}</h3></div>`);
    const $w=$(`<div class="table-wrapper"><table class="display"></table></div>`).appendTo("#results-container");
    $w.find("table").DataTable({
      data:resBy[lg],
      columns:[
        {data:"play_date",title:"📆",width:"18%",render:(d,t)=>t==="display"?formatDate(d):d},
        {data:"play_date",title:"🕒",width:"15%",render:(d,t)=>t==="display"?formatTime(d):d},
        {data:null,title:"Match",width:"40%",render:(_,__,r)=>{
           const h=r.teams_home_caption,a=r.teams_away_caption;
           const hd=h&&h.includes("Wiedikon")?'<img src="https://www.kscw.ch/clubdesk/fileservlet?type=file&id=1000716&s=djEt3z7ABYLi8hd4sWeb8Qisb2m20xnaKr4H9W6HvJnKgDU=" style="height:16px">':cleanTeamName(h,true);
           const ad=a&&a.includes("Wiedikon")?'<img src="https://www.kscw.ch/clubdesk/fileservlet?type=file&id=1000716&s=djEt3z7ABYLi8hd4sWeb8Qisb2m20xnaKr4H9W6HvJnKgDU=" style="height:16px">':cleanTeamName(a,true);
           return `${hd} – ${ad}`;}},
        {data:"result_summary",title:"🎯",width:"10%",render:d=>(!d||d==="[]"||d.length===0)?"0-0":Array.isArray(d)?d.join(", "):d}
             ],
       paging:false,searching:false,ordering:false,info:false,autoWidth:false,deferRender:true
     });
     
     // Add click handlers for modal
     $w.find("table tbody tr").addClass("clickable-row").click(function() {
       const data = $w.find("table").DataTable().row(this).data();
       showDetailModal(data);
     });
   }
   
   } catch (error) {
     console.error('Error in loadData:', error);
     $("#rankings-container").html('<div class="error-message">Error loading data: ' + error.message + '</div>');
   }
}

/* ---------- MODAL FUNCTIONS ---------- */
function showDetailModal(data) {
  const modalContent = `
    <h2>Game Details</h2>
    <table class="modal-table">
      <tr><th>Date</th><td>${formatDateWithDay(data.play_date)} ${formatTime(data.play_date)}</td></tr>
      <tr><th>Home Team</th><td>${data.teams_home_caption || 'N/A'}</td></tr>
      <tr><th>Away Team</th><td>${data.teams_away_caption || 'N/A'}</td></tr>
      <tr><th>Result</th><td>${data.resultSummary || 'N/A'}</td></tr>
      <tr><th>League</th><td>${data.league_caption || 'N/A'}</td></tr>
      <tr><th>Group</th><td>${data.group_caption || 'N/A'}</td></tr>
      <tr><th>Referees</th><td>${data.referees || 'N/A'}</td></tr>
      <tr><th>Hall</th><td>${data.hall_caption || 'N/A'}</td></tr>
      <tr><th>Address</th><td>${[data.hall_street, data.hall_number, data.hall_city, data.hall_zip].filter(Boolean).join(' ') || 'N/A'}</td></tr>
      <tr><th>Game ID</th><td>${data.game_id || 'N/A'}</td></tr>
    </table>
    <button class="detail-close" onclick="closeModal()">Close</button>
  `;
  
  $("#modalContent").html(modalContent);
  $("#dataModal").show();
}

function showRankingModal(data) {
  const modalContent = `
    <h2>Team Ranking Details</h2>
    <table class="modal-table">
      <tr><th>Rank</th><td>${data.rank || 'N/A'}</td></tr>
      <tr><th>Team</th><td>${data.teamcaption || 'N/A'}</td></tr>
      <tr><th>Points</th><td>${data.points || 'N/A'}</td></tr>
      <tr><th>Games Played</th><td>${data.games || 'N/A'}</td></tr>
      <tr><th>Wins</th><td>${data.wins || 'N/A'}</td></tr>
      <tr><th>Defeats</th><td>${data.defeats || 'N/A'}</td></tr>
      <tr><th>League</th><td>${data.league_caption || 'N/A'}</td></tr>
      <tr><th>Group</th><td>${data.group_caption || 'N/A'}</td></tr>
    </table>
    <button class="detail-close" onclick="closeModal()">Close</button>
  `;
  
  $("#modalContent").html(modalContent);
  $("#dataModal").show();
}

function closeModal() {
  $("#dataModal").hide();
}

// Close modal when clicking outside
$(document).on('click', '#dataModal', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

/* ---------- BOOT ---------- */
$(function(){
  let team = null;
  
  // Priority 1: URL parameter (most reliable for embedding)
  const urlParams = new URLSearchParams(window.location.search);
  team = urlParams.get('team');
  
  // Priority 2: Path-based detection (GitHub Pages fallback)
  if (!team) {
    const slug = window.location.pathname.split('/').filter(Boolean).pop().toLowerCase();
    team = slugToId[slug];
  }
  
  // Priority 3: Try to detect from parent window URL if embedded in iframe (may fail due to CORS)
  if (!team && window.parent !== window) {
    try {
      const parentUrl = window.parent.location.href;
      console.log('Detected embedded context, parent URL:', parentUrl);
      
      // Check for Clubdesk patterns in parent URL
      if (parentUrl.includes('clubdesk')) {
        const patterns = [
          /\/(?:team|teams)\/(\d+)/,           // /team/123
          /\/([hd][1-4]|hu23|du23|du20|hl)$/, // /h1, /d1, etc.
        ];
        
        for (const pattern of patterns) {
          const match = parentUrl.match(pattern);
          if (match) {
            if (pattern.source.includes('[hd]')) {
              team = slugToId[match[1].toLowerCase()];
            } else {
              team = match[1];
            }
            console.log('Found team from parent URL pattern:', match[1], '->', team);
            break;
          }
        }
      }
      
      // Additional check for common Clubdesk URL patterns
      if (!team) {
        const clubdeskPatterns = [
          /\/clubdesk\/.*?(\d+)/,              // /clubdesk/anything/123
          /\/clubdesk\/.*?([hd][1-4])/i,       // /clubdesk/anything/h1
          /\/clubdesk\/.*?([du]u23)/i,         // /clubdesk/anything/du23
          /\/clubdesk\/.*?(hl)/i,              // /clubdesk/anything/hl
        ];
        
        for (const pattern of clubdeskPatterns) {
          const match = parentUrl.match(pattern);
          if (match) {
            const value = match[1];
            if (slugToId[value.toLowerCase()]) {
              team = slugToId[value.toLowerCase()];
              console.log('Found team from Clubdesk pattern:', value, '->', team);
              break;
            }
          }
        }
      }
    } catch (e) {
      console.log('Could not access parent URL (cross-origin restriction):', e.message);
    }
  }
  
  // Priority 4: Try to extract from current URL if it contains Clubdesk patterns
  if (!team && window.location.href.includes('clubdesk')) {
    const url = window.location.href;
    const patterns = [
      /\/(?:team|teams)\/(\d+)/,           // /team/123
      /\/([hd][1-4]|hu23|du23|du20|hl)$/, // /h1, /d1, etc.
    ];
    
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) {
        if (pattern.source.includes('[hd]')) {
          team = slugToId[match[1].toLowerCase()];
        } else {
          team = match[1];
        }
        break;
      }
    }
  }
  
  if (!team) {
    // Show team selector when no team is detected
    showTeamSelector();
  } else {
    console.log('Loading data for team:', team);
    
    // Convert slug to ID if needed
    let teamId = team;
    if (slugToId[team]) {
      teamId = slugToId[team];
      console.log('Converted slug to ID:', team, '->', teamId);
    }
    
    loadData(teamId);
  }
});

/* ---------- TEAM SELECTOR ---------- */
function showTeamSelector() {
  const teamSelectorHtml = `
    <div class="content-section">
      <h2>Select Team</h2>
      <div style="padding: 20px; text-align: center;">
        <p style="margin-bottom: 20px; color: #666;">No team detected. Please select a team to view data:</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 800px; margin: 0 auto;">
          ${Object.entries(teamNames).map(([id, name]) => `
            <button onclick="loadData('${id}')" style="
              padding: 15px; 
              border: 2px solid #0066CC; 
              border-radius: 8px; 
              background: white; 
              color: #0066CC; 
              font-weight: bold; 
              cursor: pointer; 
              transition: all 0.3s ease;
              font-size: 14px;
            " onmouseover="this.style.background='#0066CC'; this.style.color='white'" 
               onmouseout="this.style.background='white'; this.style.color='#0066CC'">
              ${name}
            </button>
          `).join('')}
        </div>
        <p style="margin-top: 20px; font-size: 12px; color: #999;">
          Tip: You can also use ?team=h1, ?team=d1, etc. in the URL for direct access.
        </p>
      </div>
    </div>
  `;
  
  $("#rankings-container").html(teamSelectorHtml);
  $("#results-container").html('<div class="loading">Select a team above to view data</div>');
  $("#next-game-section").hide();
}
</script>

</body>
</html>