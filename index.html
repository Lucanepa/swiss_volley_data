<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<title>KSC Wiedikon Results</title>

<style>
    /* ============ RESET & BASE STYLES ============ */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: #2d3748;
        line-height: 1.6;
        min-height: 100vh;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }
    
    /* ============ HEADER STYLES ============ */
    .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
    }
    
    .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
    }
    
    /* ============ CONTROLS SECTION ============ */
    .controls-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .controls-row {
        display: flex;
        flex-direction: column;
        gap: 25px;
        align-items: center;
    }
    
    .team-selector {
        width: 100%;
        max-width: 400px;
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 16px;
        background: white;
        color: #2d3748;
        cursor: pointer;
        outline: none;
        transition: all 0.3s ease;
        font-weight: 500;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .team-selector:focus {
        border-color: #0066CC;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        transform: translateY(-2px);
    }
    
    .team-selector:hover {
        border-color: #0066CC;
        transform: translateY(-1px);
    }
    
    .chip-container {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
    }
    
    .chip {
        padding: 14px 24px;
        border: 2px solid #e2e8f0;
        border-radius: 30px;
        background: white;
        color: #64748b;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }
    
    .chip::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s;
    }
    
    .chip:hover::before {
        left: 100%;
    }
    
    .chip.active {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 102, 204, 0.3);
        background-clip: padding-box;
        -webkit-background-clip: padding-box;
    }
    
    .chip:hover:not(.active) {
        border-color: #0066CC;
        color: #0066CC;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 102, 204, 0.15);
    }
    
    /* ============ CONTENT SECTIONS ============ */
    .content-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .content-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .content-section h2 {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        padding: 20px 30px;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .sub-section {
        margin: 20px;
    }
    
    .sub-section h3 {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        padding: 15px 20px;
        margin: 0 0 10px 0;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    /* ============ NEXT GAMES SECTION ============ */
    .next-games-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .next-games-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    
    .next-games-section h2 {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        padding: 20px 30px 15px 30px;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .next-games-section h2::after {
        content: "Click any row for details";
        display: block;
        font-size: 14px;
        font-weight: 400;
        font-style: italic;
        margin-top: 8px;
        opacity: 0.9;
    }
    
    .content-section h2::after {
        content: "Click on a game to see details";
        display: block;
        font-size: 14px;
        font-weight: 400;
        font-style: italic;
        margin-top: 8px;
        opacity: 0.9;
    }
    
    .next-games-grid {
        display: grid;
        gap: 20px;
        padding: 30px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    .next-game-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 25px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }
    
    .next-game-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #0066CC, #FFD700);
    }
    
    .next-game-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        border-color: #0066CC;
    }
    
    .next-game-date {
        font-size: 16px;
        color: #0066CC;
        margin-bottom: 15px;
        text-align: center;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .next-game-teams {
        font-size: 18px;
        font-weight: 700;
        text-align: left;
        margin-bottom: 15px;
        color: #2d3748;
        line-height: 1.4;
    }
    
    .next-game-league {
        font-size: 14px;
        color: #718096;
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
    }
    
    .next-game-details-btn {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .next-game-details-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 102, 204, 0.4);
    }
    
    /* ============ CONTENT TABS ============ */
    .content-tabs {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    .content-tabs.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ============ TABLE STYLES ============ */
    .table-wrapper {
      width: 100%;
        overflow-x: auto;
        padding: 10px 20px;
    }
    
    .table-wrapper table {
        width: 100% !important;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .table-wrapper table tbody tr:first-child td {
        border-top: none;
    }
    
    .table-wrapper table tbody tr:first-child td:first-child {
        border-top-left-radius: 12px;
    }
    
    .table-wrapper table tbody tr:first-child td:last-child {
        border-top-right-radius: 12px;
    }
    
    /* Hide any DataTables header elements for Results and Next Games */
    #results-container .table-wrapper table thead,
    #results-container .table-wrapper table .dataTables_header,
    #results-container .table-wrapper table .dataTables_wrapper .dataTables_header,
    #next-games-container .table-wrapper table thead,
    #next-games-container .table-wrapper table .dataTables_header,
    #next-games-container .table-wrapper table .dataTables_wrapper .dataTables_header {
        display: none !important;
    }
    
    /* Remove any top borders from DataTables wrapper */
    .table-wrapper .dataTables_wrapper {
        border-top: none !important;
    }
    
    /* Ensure consistent column alignment */
    .table-wrapper table {
        table-layout: fixed;
    }
    
    .table-wrapper table td {
        word-wrap: break-word;
        vertical-align: top;
    }
    
    /* Specific column styling for auto-sizing */
    .date-time-column {
        width: auto !important;
    }
    
    .teams-column {
        width: auto !important;
    }
    
    .result-column {
        width: auto !important;
        text-align: right !important;
        padding-right: 1em !important;
    }
    
    /* Next Games table - all columns auto-size naturally */
    
    /* Ensure table doesn't wrap on mobile */
    .table-wrapper table {
        table-layout: fixed;
        min-width: 100%;
        white-space: nowrap;
    }
    
    .table-wrapper table td {
        word-wrap: break-word;
        vertical-align: top;
        white-space: normal;
    }
    
    .table-wrapper table th {
        padding: 15px 12px;
        font-weight: 600;
        text-align: center;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #2d3748;
    }
    
    /* Rankings table specific header alignment */
    #rankings-container .table-wrapper table th.text-center {
        text-align: center;
    }
    
    #rankings-container .table-wrapper table th.text-left {
        text-align: left;
    }
    
    /* Rankings table specific content alignment */
    #rankings-container .table-wrapper table td.text-center {
        text-align: center;
    }
    
    #rankings-container .table-wrapper table td.text-left {
        text-align: left;
    }
    
        .table-wrapper table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
        transition: background-color 0.2s ease;
    }
    
    /* Team names left-aligned */
    .table-wrapper table td:nth-child(2) {
      text-align: left;
    }
    
    /* Center align match column content vertically */
    .table-wrapper table td:nth-child(3) {
        vertical-align: middle;
    }
    
    .table-wrapper table tbody tr:hover {
        background-color: #f7fafc;
    }
    
    .clickable-row {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clickable-row:hover {
        background-color: #edf2f7 !important;
    }
    
    /* ============ LOADING STYLES ============ */
    .loading-container {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }
    
    .loading-text {
        font-size: 18px;
        color: #718096;
        margin-bottom: 20px;
        font-weight: 500;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #0066CC;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ============ ERROR MESSAGE STYLES ============ */
    .error-message {
        background: #fed7d7;
        border: 1px solid #feb2b2;
        color: #c53030;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin: 20px;
        font-weight: 500;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    /* ============ MODAL STYLES ============ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-in-out;
    }

    .modal-content {
        background: white;
        margin: 30px auto;
        padding: 0;
        border-radius: 18px;
      width: 90%;
        max-width: 650px;
      max-height: 75vh;
      overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-in-out;
    }
    
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 18px 18px 0 0;
        text-align: center;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .modal-body {
        padding: 20px;
    }

    .modal-table {
      width: 100%;
      border-collapse: collapse;
        margin-top: 15px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .modal-table th,
    .modal-table td {
        padding: 10px 15px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
    }
    
    .modal-table td {
        font-size: 12px;
        color: #2d3748;
    }
    
    .modal-close {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
      font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 15px;
        width: 100%;
    }
    
    .modal-close:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    /* ============ LAST UPDATED SECTION ============ */
    .last-updated-section {
        margin-top: 8px;
        text-align: center;
    }
    
    .last-updated-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .last-updated-label {
        font-size: 0.80rem;
        color: #718096;
        font-weight: 500;
    }
    
    #last-updated-time {
        font-size: 0.80rem;
        color: #2d3748;
        font-weight: 600;
        background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* ============ MOBILE RESPONSIVE ============ */
    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        
        .header h1 {
            font-size: 2rem;
        }
        
        .controls-section {
            padding: 15px;
      margin-bottom: 20px;
    }

        .controls-row {
            gap: 20px;
        }
        
        .team-selector {
            font-size: 16px;
            padding: 14px 16px;
        }
        
        .chip {
            padding: 12px 20px;
      font-size: 14px;
        }
        
        .chip-container {
            gap: 10px;
        }
        
        .next-games-grid {
            padding: 20px;
            gap: 15px;
            grid-template-columns: 1fr;
        }
        
        .next-game-card {
            padding: 20px;
        }
        
        .next-game-teams {
            font-size: 16px;
        }
        
        .content-section h2 {
            font-size: 1.3rem;
            padding: 15px 20px;
        }
        
        .sub-section h3 {
            font-size: 1rem;
            padding: 12px 16px;
        }
        
        .table-wrapper {
            padding: 15px;
        }
        
                .table-wrapper table th,
        .table-wrapper table td {
            padding: 8px 6px;
            font-size: 11px;
        }
        
        .modal-content {
            margin: 20px auto;
            width: 95%;
        }
        
        .modal-header {
      padding: 20px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-table th,
        .modal-table td {
            padding: 12px 15px;
            font-size: 13px;
        }
        
        .last-updated-section {
            margin-top: 5px;
        }
        
        .last-updated-content {
            flex-direction: column;
            gap: 2px;
        }
        
        .last-updated-label,
        #last-updated-time {
            font-size: 0.70rem;
        }
    }
    
        @media (max-width: 480px) {
        .controls-section {
            padding: 12px;
        }
        
        .next-games-grid {
            padding: 15px;
            gap: 12px;
        }
        
        .next-game-card {
            padding: 15px;
        }
        
        .next-game-teams {
            font-size: 15px;
        }
        
        .chip {
            padding: 10px 16px;
            font-size: 13px;
        }
        
        /* Extra compact rankings for very small screens */
        .table-wrapper table th,
        .table-wrapper table td {
            padding: 6px 4px;
            font-size: 10px;
        }
        
        .table-wrapper {
            padding: 10px;
      }
    }
</style>
</head>
<body>

<div class="container">
    <!-- ===== HEADER ===== -->
    <div class="header">
        </div>

    <!-- ===== CONTROLS SECTION ===== -->
    <div class="controls-section">
        <div class="controls-row">
            <div style="display: flex; gap: 15px; align-items: center; justify-content: center; width: 100%; max-width: 500px;">
                <select id="team-selector" class="team-selector">
                    <option value="all">All Teams</option>
                    <!-- Team options will be populated dynamically -->
                </select>
                
                <button onclick="forceReload()" style="
                    background: linear-gradient(135deg, #0066CC 0%, #FFD700 100%);
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    white-space: nowrap;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    🔄 Refresh
                </button>
            </div>
            
            <div class="chip-container">
                <div class="chip active" data-tab="next-games">Next Games</div>
                <div class="chip" data-tab="last-games">Latest results</div>
                <div class="chip" data-tab="results"> All Results</div>
                <div class="chip" data-tab="rankings">Rankings</div>
            </div>
            
            <!-- ===== LAST UPDATED SECTION ===== -->
            <div id="last-updated-section" class="last-updated-section">
                <div class="last-updated-content">
                    <span class="last-updated-label">Last updated:</span>
                    <span id="last-updated-time">Loading...</span>
                </div>
            </div>
    </div>
  </div>

    <!-- ===== NEXT GAMES SECTION ===== -->
    <div id="next-games-section" class="next-games-section content-tabs active">
        <h2>Next Games</h2>
        <div id="next-games-container">
      <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Select a team to view next games</div>
      </div>
    </div>
  </div>

    <!-- ===== LAST GAMES SECTION ===== -->
    <div id="last-games-section" class="next-games-section content-tabs">
        <h2>Latest results</h2>
        <div id="last-games-container">
      <div class="loading-container">
                <div class="spinner"></div>
      </div>
    </div>
  </div>

    <!-- ===== RESULTS SECTION ===== -->
    <div id="results-section" class="content-section content-tabs">
        <h2>📊 Results</h2>
        <div id="results-container">
      <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Select a team to view results</div>
        </div>
      </div>
    </div>

    <!-- ===== RANKINGS SECTION ===== -->
    <div id="rankings-section" class="content-section content-tabs">
        <h2>🏆 Rankings</h2>
        <div id="rankings-container">
            <div class="loading-container">
                <div class="spinner"></div>
                <div class="loading-text">Select a team to view rankings</div>
  </div>
</div>
    </div>
</div>

<!-- ===== MODAL ===== -->
<div id="dataModal" class="modal">
  <div class="modal-content">
        <div class="modal-body">
    <div id="modalContent"></div>
        </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- CONFIGURATION ---------- */
const SUPABASE_URL = 'https://wilrrlwqgvzjdhmnwmte.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_smrIIJd_DJofe68QRJmB1w_qiASLbqE';

// Initialize Supabase client
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- TEAM MAPPINGS ---------- */
const teamNames = {
    "12747": "KSC Wiedikon H3",
    "1394": "KSC Wiedikon D4", 
    "14040": "KSC Wiedikon DU23-2",
    "7563": "KSC Wiedikon HU23-1",
    "1393": "KSC Wiedikon D2",
    "541": "KSC Wiedikon H2",
    "6023": "KSC Wiedikon Legends",
    "4689": "KSC Wiedikon D3",
    "2743": "KSC Wiedikon H1",
    "1395": "KSC Wiedikon D1",
    "2301": "KSC Wiedikon DU23-1"
};

const slugToId = {
    "h3": "12747",
    "d4": "1394",
    "du20": "14040",
    "hu23": "7563",
    "d2": "1393",
    "h2": "541",
    "hl": "6023",
    "d3": "4689",
    "h1": "2743",
    "d1": "1395",
    "du23": "2301"
};

/* ---------- UTILITY FUNCTIONS ---------- */
function pad(n) {
    return n.toString().padStart(2, "0");
}

function formatDate(d) {
    const t = new Date(d);
    return isNaN(t) ? "" : `${pad(t.getDate())}.${pad(t.getMonth() + 1)}.${String(t.getFullYear()).slice(-2)}`;
}

function formatTime(d) {
    // Try to extract time directly from the string first
    if (typeof d === 'string') {
        // Look for time pattern HH:MM or HH:MM:SS
        const timeMatch = d.match(/(\d{1,2}):(\d{2})(?::\d{2})?/);
        if (timeMatch) {
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            return `${pad(hours)}:${pad(minutes)}`;
        }
    }
    
    // Fallback to Date object method
    const t = new Date(d);
    return isNaN(t) ? "" : `${pad(t.getHours())}:${pad(t.getMinutes())}`;
}

function formatDateWithDay(d) {
    // Handle timezone conversion - if the date string doesn't have timezone info, 
    // treat it as UTC and convert to local time
    let dateString = d;
    if (typeof d === 'string' && !d.includes('Z') && !d.includes('+')) {
        // If no timezone info, assume UTC and add Z
        dateString = d + 'Z';
    }
    const t = new Date(dateString);
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    return isNaN(t) ? "" : `${days[t.getDay()]} ${formatDate(d)}`;
}

function formatLastUpdated(d) {
    if (!d) return "Unknown";
    
    // Handle timezone conversion - if the date string doesn't have timezone info, 
    // treat it as UTC and convert to local time
    let dateString = d;
    if (typeof d === 'string' && !d.includes('Z') && !d.includes('+')) {
        // If no timezone info, assume UTC and add Z
        dateString = d + 'Z';
    }
    
    const t = new Date(dateString);
    if (isNaN(t)) return "Unknown";
    
    // Format as dd.mm.yy hh:mm
    const day = pad(t.getDate());
    const month = pad(t.getMonth() + 1);
    const year = String(t.getFullYear()).slice(-2);
    const hours = pad(t.getHours());
    const minutes = pad(t.getMinutes());
    
    return `${day}.${month}.${year} ${hours}:${minutes}`;
}

function cleanTeamName(n, r = false) {
    if (!n) return "";
    let c = n.replace(/KSC\s+Wiedikon/g, "KSCW");
    if (r) c = c.replace(/KSCW\s+/g, "");
    return c.replace(/^(VBC|VC|Volley|Volleyball)\s+/i, "").replace(/\s+(VBC|VC|Volley|Volleyball)$/i, "").trim();
}

function leagueOrGroup(row) {
    return row.league_caption && row.league_caption.toLowerCase().includes("cup") ? row.league_caption : (row.group_caption || "Unknown League");
}

/* ---------- DATA TABLE CLEANUP ---------- */
function destroyTables(selector) {
    $(selector).find("table.dataTable").each(function() {
        if ($.fn.DataTable.isDataTable(this)) {
            $(this).DataTable().destroy();
        }
    });
}

/* ---------- RENDER NEXT GAMES ---------- */
function renderNextGames(games) {
    if (!games || games.length === 0) {
        return '<div class="error-message">No upcoming games found.</div>';
    }
    
    // Group games by date
    const gamesByDate = {};
    games.forEach(game => {
        const dateKey = formatDate(game.play_date);
        if (!gamesByDate[dateKey]) {
            gamesByDate[dateKey] = [];
        }
        gamesByDate[dateKey].push(game);
    });
    
    // Sort dates and take first 5 dates (or more if same-day games exist)
    const sortedDates = Object.keys(gamesByDate).sort((a, b) => {
        const dateA = new Date(a.split('.').reverse().join('-'));
        const dateB = new Date(b.split('.').reverse().join('-'));
        return dateA - dateB;
    });
    
    const selectedDates = sortedDates.slice(0, 5);
    
    let html = '<div class="table-wrapper"><table class="display"><tbody>';
    
    selectedDates.forEach(dateKey => {
        const dateGames = gamesByDate[dateKey];
        const firstGame = dateGames[0];
        const dateWithDay = formatDateWithDay(firstGame.play_date);
        
        dateGames.forEach(game => {
            const time = formatTime(game.play_date);
            const home = game.teams_home_caption || "Unknown Team";
            const away = game.teams_away_caption || "Unknown Team";
            const league = game.league_caption || "Unknown League";
            const isCup = league.toLowerCase().includes("cup");
            const leagueIcon = isCup ? "🏆" : "🎖️";
            
            // Determine gender from team names (H = male, D = female, Legends = male)
            const isMale = home.includes(" H") || away.includes(" H") || home.includes("Legends") || away.includes("Legends");
            const isFemale = home.includes(" D") || away.includes(" D");
            
            // Set color and gender indicator
            let leagueColor = "";
            let genderIndicator = "";
            
            if (isMale) {
                leagueColor = "color: #0066CC; font-weight: bold;"; // Blue for male
                genderIndicator = " (M)";
            } else if (isFemale) {
                leagueColor = "color: #E91E63; font-weight: bold;"; // Pink for female
                genderIndicator = " (F)";
            }
            
            // Make KSC Wiedikon team names bold (including Home:/Away: label)
            const formatTeamDisplay = (label, teamName) => {
                if (teamName.includes("KSC Wiedikon")) {
                    return `<strong><em>${label}</em> ${teamName}</strong>`;
                }
                return `<em>${label}</em> ${teamName}`;
            };
            
            html += `
                <tr class="clickable-row" data-game-id="${game.wiedikon_team_id}" data-game-date="${game.play_date}">
                    <td style="text-align: left;">
                        <div>${dateWithDay}</div>
                        <div>${time}</div>
                    </td>
                    <td style="text-align: left;">
                        <div>${formatTeamDisplay("Home:", home)}</div>
                        <div>${formatTeamDisplay("Away:", away)}</div>
                    </td>
                    <td style="${leagueColor}">${leagueIcon} ${league}${genderIndicator}</td>
                </tr>
            `;
        });
    });
    
    html += '</tbody></table></div>';
    return html;
}

/* ---------- RENDER LAST GAMES ---------- */
function renderLastGames(games) {
    if (!games || games.length === 0) {
        return '<div class="error-message">No recent games found.</div>';
    }
    
    // Group games by date
    const gamesByDate = {};
    games.forEach(game => {
        const dateKey = formatDate(game.play_date);
        if (!gamesByDate[dateKey]) {
            gamesByDate[dateKey] = [];
        }
        gamesByDate[dateKey].push(game);
    });
    
    // Sort dates and take last 5 dates (or more if same-day games exist)
    const sortedDates = Object.keys(gamesByDate).sort((a, b) => {
        const dateA = new Date(a.split('.').reverse().join('-'));
        const dateB = new Date(b.split('.').reverse().join('-'));
        return dateB - dateA; // Most recent first
    });
    
    const selectedDates = sortedDates.slice(0, 5);
    
    let html = '<div class="table-wrapper"><table class="display"><tbody>';
    
    selectedDates.forEach(dateKey => {
        const dateGames = gamesByDate[dateKey];
        const firstGame = dateGames[0];
        const dateWithDay = formatDateWithDay(firstGame.play_date);
        
        dateGames.forEach(game => {
            const time = formatTime(game.play_date);
            const home = game.teams_home_caption || "Unknown Team";
            const away = game.teams_away_caption || "Unknown Team";
            const league = game.league_caption || "Unknown League";
            const isCup = league.toLowerCase().includes("cup");
            const leagueIcon = isCup ? "🏆" : "🎖️";
            
            // Parse result_summary
            let resultSummary = game.result_summary;
            if (typeof resultSummary === 'string') {
                try {
                    resultSummary = JSON.parse(resultSummary);
                } catch (e) {
                    resultSummary = null;
                }
            }
            
            // Determine winner and result
            let homeStar = "", awayStar = "", resultDisplay = "-";
            if (resultSummary && typeof resultSummary === 'object' && resultSummary !== null) {
                if (resultSummary.wonSetsHomeTeam !== undefined && resultSummary.wonSetsAwayTeam !== undefined) {
                    resultDisplay = `${resultSummary.wonSetsHomeTeam}-${resultSummary.wonSetsAwayTeam}`;
                    if (resultSummary.winner === "team_home") {
                        homeStar = " ⭐";
                    } else if (resultSummary.winner === "team_away") {
                        awayStar = " ⭐";
                    }
                }
            }
            
            // Determine gender from team names (H = male, D = female, Legends = male)
            const isMale = home.includes(" H") || away.includes(" H") || home.includes("Legends") || away.includes("Legends");
            const isFemale = home.includes(" D") || away.includes(" D");
            
            // Set color and gender indicator
            let leagueColor = "";
            let genderIndicator = "";
            
            if (isMale) {
                leagueColor = "color: #0066CC; font-weight: bold;"; // Blue for male
                genderIndicator = " (M)";
            } else if (isFemale) {
                leagueColor = "color: #E91E63; font-weight: bold;"; // Pink for female
                genderIndicator = " (F)";
            }
            
            // Make KSC Wiedikon team names bold (including Home:/Away: label)
            const formatTeamDisplay = (label, teamName) => {
                if (teamName.includes("KSC Wiedikon")) {
                    return `<strong><em>${label}</em> ${teamName}</strong>`;
                }
                return `<em>${label}</em> ${teamName}`;
            };
            
            html += `
                <tr class="clickable-row" data-game-id="${game.wiedikon_team_id}" data-game-date="${game.play_date}">
                    <td style="text-align: left;">
                        <div>${dateWithDay}</div>
                        <div>${time}</div>
                    </td>
                    <td style="text-align: left;">
                        <div>${formatTeamDisplay("Home:", home)}${homeStar}</div>
                        <div>${formatTeamDisplay("Away:", away)}${awayStar}</div>
                    </td>
                    <td style="text-align: left;">
                        <div><strong>${resultDisplay}</strong></div>
                        <div style="${leagueColor}">${leagueIcon} ${league}${genderIndicator}</div>
                    </td>
                </tr>
            `;
        });
    });
    
    html += '</tbody></table></div>';
    return html;
}

/* ---------- RENDER RESULTS ---------- */
function renderResults(resData) {
    destroyTables("#results-container");
    $("#results-container").empty();
    
    if (!resData || resData.length === 0) {
        $("#results-container").html('<div class="error-message">No results found.</div>');
        return;
    }
    
    const resBy = {};
    resData.forEach(r => (resBy[leagueOrGroup(r)] ??= []).push(r));
    
    // Sort leagues: cup first, then normal leagues
    const sortedLeagues = Object.keys(resBy).sort((a, b) => {
        const aIsCup = a.toLowerCase().includes("cup");
        const bIsCup = b.toLowerCase().includes("cup");
        if (aIsCup && !bIsCup) return -1;
        if (!aIsCup && bIsCup) return 1;
        return a.localeCompare(b);
    });
    
    for (const lg of sortedLeagues) {
        $("#results-container").append(`<div class="sub-section"><h3>${lg}</h3></div>`);
        const $w = $(`<div class="table-wrapper"><table class="display"></table></div>`).appendTo("#results-container");
        
        $w.find("table").DataTable({
            data: resBy[lg],
            columns: [
                {
                    data: "play_date",
                    className: "date-time-column",
                    render: (d, t) => {
                        if (t === "display") {
                            const dateWithDay = formatDateWithDay(d);
                            const time = formatTime(d);
                            return `<div style="text-align: left;">${dateWithDay}</div><div style="text-align: left;">${time}</div>`;
                        }
                        return d;
                    }
                },
                {
                    data: null,
                    className: "teams-column",
                    render: (_, __, r) => {
                        const h = r.teams_home_caption, a = r.teams_away_caption;
                        let resultSummary = r.result_summary;
                        
                        // Try to parse result_summary if it's a JSON string
                        if (typeof resultSummary === 'string') {
                            try {
                                resultSummary = JSON.parse(resultSummary);
                            } catch (e) {
                                // If parsing fails, keep as string
                            }
                        }
                        
                        // Determine winner from result_summary
                        let homeStar = "", awayStar = "";
                        if (resultSummary && typeof resultSummary === 'object' && resultSummary !== null && resultSummary.winner) {
                            if (resultSummary.winner === "team_home") {
                                homeStar = " ⭐";
                            } else if (resultSummary.winner === "team_away") {
                                awayStar = " ⭐";
                            }
                        }
                        
                        // Make KSC Wiedikon team names bold (including Home:/Away: label)
                        const formatTeamDisplay = (label, teamName, star) => {
                            if (teamName.includes("KSC Wiedikon")) {
                                return `<strong><em>${label}</em> ${teamName}${star}</strong>`;
                            }
                            return `<em>${label}</em> ${teamName}${star}`;
                        };
                        
                        return `<div style="text-align: left;">${formatTeamDisplay("Home:", h, homeStar)}</div><div style="text-align: left;">${formatTeamDisplay("Away:", a, awayStar)}</div>`;
                    }
                },
                {
                    data: "result_summary",
                    className: "result-column",
                    render: d => {
                        if (!d || d === "[]" || d.length === 0) {
                            return `<div style="text-align: left;">-</div>`;
                        }
                        
                        // Try to parse if it's a JSON string
                        let resultData = d;
                        if (typeof d === 'string') {
                            try {
                                resultData = JSON.parse(d);
                            } catch (e) {
                                // If parsing fails, treat as string
                                resultData = d;
                            }
                        }
                        
                        // Handle result_summary object
                        if (typeof resultData === 'object' && resultData !== null && resultData.wonSetsHomeTeam !== undefined && resultData.wonSetsAwayTeam !== undefined) {
                            return `<div style="text-align: left;"><strong>${resultData.wonSetsHomeTeam}-${resultData.wonSetsAwayTeam}</strong></div>`;
                        }
                        
                        // Fallback for other formats (arrays, etc.)
                        const result = Array.isArray(resultData) ? resultData.join(", ") : resultData;
                        return `<div style="text-align: left;">${result}</div>`;
                    }
                }
            ],
            paging: false,
            searching: false,
            ordering: false,
            info: false,
            autoWidth: false,
            deferRender: true
        });
        
        // Add click handlers for modal
        $w.find("table tbody tr").addClass("clickable-row").click(async function() {
            const data = $w.find("table").DataTable().row(this).data();
            await showDetailModal(data);
        });
    }
}

/* ---------- RENDER RANKINGS ---------- */
function renderRankings(rankData, selectedTeamId) {
    destroyTables("#rankings-container");
    $("#rankings-container").empty();
    
    if (!rankData || rankData.length === 0) {
        $("#rankings-container").html('<div class="error-message">No rankings found.</div>');
        return;
    }
  
  // Filter out cup competitions and group by league/group
    const rBy = {};
  rankData.forEach(r => {
    if (r.league_caption && r.league_caption.toLowerCase().includes("cup")) {
            return;
    }
    
    const groupKey = r.group_caption || "Unknown League";
    if (!rBy[groupKey]) rBy[groupKey] = [];
    rBy[groupKey].push(r);
  });
    
    for (const lg in rBy) {
        // Get the team name for this league/group - find the Wiedikon team
        const wiedikonTeam = rBy[lg].find(team => team.teamcaption && team.teamcaption.toLowerCase().includes("wiedikon")) || rBy[lg][0];
        const teamName = wiedikonTeam && wiedikonTeam.teamcaption ? wiedikonTeam.teamcaption : lg;
        const displayTitle = `${lg} - ${teamName}`;
        
        $("#rankings-container").append(`<div class="sub-section"><h3>${displayTitle}</h3></div>`);
        const $w = $(`<div class="table-wrapper"><table class="display"></table></div>`).appendTo("#rankings-container");
        
     $w.find("table").DataTable({
            data: rBy[lg],
            columns: [
                {data: "rank", title: "🏆", width: "8%", className: "text-center"},
                {data: "teamcaption", title: "🏐", width: "42%", className: "text-left", render: (d, t) => t === "display" ? cleanTeamName(d) : d},
                {data: "points", title: "🧮", width: "12%", className: "text-center"},
                {data: "games", title: "#️⃣", width: "12%", className: "text-center"},
                {data: "wins", title: "🎉", width: "13%", className: "text-center"},
                {data: "defeats", title: "💔", width: "13%", className: "text-center"}
            ],
            paging: false,
            searching: false,
            ordering: false,
            info: false,
            autoWidth: false,
            deferRender: true,
       createdRow: (row, data) => {
         if (data.teamcaption && data.teamcaption.toLowerCase().includes("wiedikon")) {
           $(row).find("td").css({
             "background-color": "#e6f3ff",
             "font-weight": "bold"
           });
         }
         // Ensure vertical center alignment for team names
         $(row).find("td:nth-child(2)").css({
           "vertical-align": "middle"
         });
       }
     });
     
     // Add click handlers for modal
     $w.find("table tbody tr").addClass("clickable-row").click(function() {
       const data = $w.find("table").DataTable().row(this).data();
       showRankingModal(data);
     });
    }
}

/* ---------- MODAL FUNCTIONS ---------- */
async function showDetailModal(data, isNextGame = false) {
    // Build address for Google Maps
    const addressParts = [data.hall_street, data.hall_number, data.hall_city, data.hall_zip].filter(Boolean);
    const address = addressParts.join(' ');
    const addressDisplay = address || 'N/A';
    
    // Fetch scorer information
    let scorerInfo = '';
    try {
        console.log('Fetching scorer data for game_id:', data.game_id);
        
        // First try to get basic scorer data
        const { data: scorerData, error: scorerError } = await supabaseClient
            .from('scorer_matches')
            .select('*')
            .eq('gamen', data.game_id)
            .single();
        
        console.log('Scorer query result:', { scorerData, scorerError });
        
        if (!scorerError && scorerData) {
            // Build scorer information
            if (scorerData.scorer_id) {
                scorerInfo += 'Scorer: ';
                try {
                    const { data, error } = await supabaseClient
                        .from('scorer_scorers')
                        .select('fname, lname')
                        .eq('id', scorerData.scorer_id)
                        .single();
                    
                    if (!error && data) {
                        const firstName = data.fname || '';
                        const lastName = data.lname || '';
                        scorerInfo += `${firstName} ${lastName}`.trim();
                    }
                } catch (e) {
                    console.log('scorer_scorers query failed:', e);
                }
                scorerInfo += '<br>';
            }
            
            if (scorerData.taefeler_id) {
                scorerInfo += 'Täfeler: ';
                try {
                    const { data, error } = await supabaseClient
                        .from('scorer_scorers')
                        .select('fname, lname')
                        .eq('id', scorerData.taefeler_id)
                        .single();
                    
                    if (!error && data) {
                        const firstName = data.fname || '';
                        const lastName = data.lname || '';
                        scorerInfo += `${firstName} ${lastName}`.trim();
                    }
                } catch (e) {
                    console.log('scorer_scorers query failed for täfeler:', e);
                }
                scorerInfo += '<br>';
            }
            
            if (scorerData.scorer_taefeler_id) {
                scorerInfo += 'Scorer-Täfeler: ';
                try {
                    const { data, error } = await supabaseClient
                        .from('scorer_scorers')
                        .select('fname, lname')
                        .eq('id', scorerData.scorer_taefeler_id)
                        .single();
                    
                    if (!error && data) {
                        const firstName = data.fname || '';
                        const lastName = data.lname || '';
                        scorerInfo += `${firstName} ${lastName}`.trim();
                    }
                } catch (e) {
                    console.log('scorer_scorers query failed for scorer-täfeler:', e);
                }
                scorerInfo += '<br>';
            }
        }
        
        console.log('Final scorer info:', scorerInfo);
    } catch (error) {
        console.warn('Could not fetch scorer information:', error);
    }
    
    // Build referee information
    let refereeInfo = 'N/A';
    if (data.referee_1) {
        if (data.referee_2) {
            refereeInfo = `1SR: ${data.referee_1}, 2SR: ${data.referee_2}`;
        } else {
            refereeInfo = `1SR: ${data.referee_1}`;
        }
    }
    
    // Build result summary
    let resultSummaryHtml = 'N/A';
    let resultSummary = data.result_summary;
    
    // Try to parse if it's a JSON string
    if (typeof resultSummary === 'string') {
        try {
            resultSummary = JSON.parse(resultSummary);
        } catch (e) {
            // If parsing fails, keep as string
        }
    }
    
    if (resultSummary && typeof resultSummary === 'object' && resultSummary !== null) {
        if (resultSummary.wonSetsHomeTeam !== undefined && resultSummary.wonSetsAwayTeam !== undefined) {
            const homeTeam = data.teams_home_caption || 'Home Team';
            const awayTeam = data.teams_away_caption || 'Away Team';
            const winner = resultSummary.winner === 'team_home' ? homeTeam : resultSummary.winner === 'team_away' ? awayTeam : 'Tie';
            resultSummaryHtml = `<strong>${resultSummary.wonSetsHomeTeam}-${resultSummary.wonSetsAwayTeam}</strong>`;
        }
    }
    
    // Build set results
    let setResultsHtml = 'N/A';
    let setResults = data.set_results;
    
    // Try to parse if it's a JSON string
    if (typeof setResults === 'string') {
        try {
            setResults = JSON.parse(setResults);
        } catch (e) {
            // If parsing fails, keep as string
        }
    }
    
    if (setResults && Array.isArray(setResults) && setResults.length > 0) {
        const homeTeam = data.teams_home_caption || 'Home Team';
        const awayTeam = data.teams_away_caption || 'Away Team';
        
        // Determine icons based on team names
        const homeIcon = homeTeam.includes('KSC Wiedikon') ? 
            '<img src="https://kscw.ch/clubdesk/fileservlet?type=file&id=1000716&s=djEt3z7ABYLi8hd4sWeb8Qisb2m20xnaKr4H9W6HvJnKgDU=" alt="KSC Wiedikon" style="width: 20px; height: 20px; vertical-align: middle;">' : 
            '⚔️';
        const awayIcon = awayTeam.includes('KSC Wiedikon') ? 
            '<img src="https://kscw.ch/clubdesk/fileservlet?type=file&id=1000716&s=djEt3z7ABYLi8hd4sWeb8Qisb2m20xnaKr4H9W6HvJnKgDU=" alt="KSC Wiedikon" style="width: 20px; height: 20px; vertical-align: middle;">' : 
            '⚔️';
        
        setResultsHtml = '<div style="margin-top: 10px;">';
        setResults.forEach((set, index) => {
            const setNumber = index + 1;
            setResultsHtml += `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 5px;">
                <strong>Set ${setNumber}:</strong> ${homeIcon} ${set.home} - ${set.away} ${awayIcon}
            </div>`;
        });
        setResultsHtml += '</div>';
    }
    
  const modalContent = `
    <table class="modal-table">
            <tr><th>📅 Date</th><td>${formatDateWithDay(data.play_date)} ${formatTime(data.play_date)}</td></tr>
            <tr><th>🏠 Home Team</th><td>${data.teams_home_caption || 'N/A'}</td></tr>
            <tr><th>✈️ Away Team</th><td>${data.teams_away_caption || 'N/A'}</td></tr>
            ${!isNextGame ? `<tr><th>🏆 Result</th><td>${resultSummaryHtml}</td></tr>` : ''}
            ${!isNextGame ? `<tr><th>🎯 Set Results</th><td>${setResultsHtml}</td></tr>` : ''}
            <tr><th>🏆 League</th><td>${data.league_caption || 'N/A'}</td></tr>
            <tr><th>👥 Group</th><td>${data.group_caption || 'N/A'}</td></tr>
            <tr><th>🏟️ Hall</th><td>${data.hall_caption || 'N/A'}</td></tr>
            <tr><th>📍 Address</th><td>${address !== 'N/A' ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" style="color: #667eea; text-decoration: none;">${addressDisplay} 🗺️</a>` : addressDisplay}</td></tr>
            <tr><th>👨‍⚖️ Referees</th><td>${refereeInfo}</td></tr>
            ${scorerInfo ? `<tr><th>📝 Scorers</th><td>${scorerInfo}</td></tr>` : ''}
            <tr><th>🆔 Game ID</th><td>${data.game_id || 'N/A'}</td></tr>
    </table>
  `;
  
    $("#modalTitle").text("Game Details");
  $("#modalContent").html(modalContent);
  $("#dataModal").show();
}

function showRankingModal(data) {
  const modalContent = `
    <table class="modal-table">
            <tr><th>🎖️ Rank</th><td>${data.rank !== undefined && data.rank !== null ? data.rank : 'N/A'}</td></tr>
            <tr><th>🏐 Team</th><td>${data.teamcaption || 'N/A'}</td></tr>
            <tr><th>📊 Points</th><td>${data.points !== undefined && data.points !== null ? data.points : 'N/A'}</td></tr>
            <tr><th>🎮 Games Played</th><td>${data.games !== undefined && data.games !== null ? data.games : 'N/A'}</td></tr>
            <tr><th>🏆 Wins</th><td>${data.wins !== undefined && data.wins !== null ? data.wins : 'N/A'}</td></tr>
            <tr><th>💔 Losses</th><td>${data.defeats !== undefined && data.defeats !== null ? data.defeats : 'N/A'}</td></tr>
            <tr><th>🏆 League</th><td>${data.league_caption || 'N/A'}</td></tr>
            <tr><th>👥 Group</th><td>${data.group_caption || 'N/A'}</td></tr>
    </table>
  `;
  
    $("#modalTitle").text("Team Ranking Details");
  $("#modalContent").html(modalContent);
  $("#dataModal").show();
}

function closeModal() {
  $("#dataModal").hide();
}

// Close modal when clicking outside
$(document).on('click', '#dataModal', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

/* ---------- TAB SWITCHING ---------- */
function switchTab(tabName) {
    $('.content-tabs').removeClass('active');
    $(`#${tabName}-section`).addClass('active');
    
    $('.chip').removeClass('active');
    $(`.chip[data-tab="${tabName}"]`).addClass('active');
}

/* ---------- LOAD NEXT GAMES DATA ---------- */
async function loadDataNextGames(teamId) {
    console.log('Loading next games for team:', teamId);
    
    $("#next-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading next games...</div></div>');
    
    try {
        let nextGamesData;
        
        if (teamId === 'all') {
            const { data: nextGamesAll, error: nextGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .gte('play_date', new Date().toISOString().split('T')[0])
                .order('play_date', { ascending: true });
            
            if (nextGamesError) throw nextGamesError;
            nextGamesData = nextGamesAll;
        } else {
            const { data: nextGamesTeam, error: nextGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .eq('wiedikon_team_id', teamId)
                .gte('play_date', new Date().toISOString().split('T')[0])
                .order('play_date', { ascending: true });
            
            if (nextGamesError) throw nextGamesError;
            nextGamesData = nextGamesTeam;
        }
        
        // Render next games (future only)
        $("#next-games-container").html(renderNextGames(nextGamesData));
        
        // Add click handlers for next game rows
        $("#next-games-container .clickable-row").on('click', async function() {
            const row = $(this);
            const teamId = row.data('game-id');
            const gameDate = row.data('game-date');
            
            const gameData = nextGamesData.find(g => 
                g.wiedikon_team_id == teamId && 
                g.play_date === gameDate
            );
            
            if (gameData) {
                await showDetailModal(gameData, true);
            }
        });
        
    } catch (error) {
        console.error('Error in loadDataNextGames:', error);
        $("#next-games-container").html('<div class="error-message">Error loading next games: ' + error.message + '</div>');
    }
}

/* ---------- LOAD RESULTS DATA ---------- */
async function loadDataResults(teamId) {
    console.log('Loading results for team:', teamId);
    
    $("#results-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading results...</div></div>');
    
    try {
        let allGamesData;
        
        if (teamId === 'all') {
            const { data: allGamesAll, error: allGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .order('play_date', { ascending: true }); // Oldest first for results
            
            if (allGamesError) throw allGamesError;
            allGamesData = allGamesAll;
        } else {
            const { data: allGamesTeam, error: allGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .eq('wiedikon_team_id', teamId)
                .order('play_date', { ascending: true }); // Oldest first for results
            
            if (allGamesError) throw allGamesError;
            allGamesData = allGamesTeam;
        }
        
        // Render results (all games)
        renderResults(allGamesData);
        
    } catch (error) {
        console.error('Error in loadDataResults:', error);
        $("#results-container").html('<div class="error-message">Error loading results: ' + error.message + '</div>');
    }
}

/* ---------- LOAD LAST GAMES DATA ---------- */
async function loadDataLastGames(teamId) {
    console.log('Loading last games for team:', teamId);
    
    $("#last-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading last games...</div></div>');
    
    try {
        let lastGamesData;
        
        if (teamId === 'all') {
            const { data: lastGamesAll, error: lastGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .lt('play_date', new Date().toISOString().split('T')[0])
                .order('play_date', { ascending: false }); // Most recent first
            
            if (lastGamesError) throw lastGamesError;
            lastGamesData = lastGamesAll;
        } else {
            const { data: lastGamesTeam, error: lastGamesError } = await supabaseClient
                .from('games_complete')
                .select('*')
                .eq('wiedikon_team_id', teamId)
                .lt('play_date', new Date().toISOString().split('T')[0])
                .order('play_date', { ascending: false }); // Most recent first
            
            if (lastGamesError) throw lastGamesError;
            lastGamesData = lastGamesTeam;
        }
        
        // Render last games (past only)
        $("#last-games-container").html(renderLastGames(lastGamesData));
        
        // Add click handlers for last game rows
        $("#last-games-container .clickable-row").on('click', async function() {
            const row = $(this);
            const teamId = row.data('game-id');
            const gameDate = row.data('game-date');
            
            const gameData = lastGamesData.find(g => 
                g.wiedikon_team_id == teamId && 
                g.play_date === gameDate
            );
            
            if (gameData) {
                await showDetailModal(gameData);
            }
        });
        
    } catch (error) {
        console.error('Error in loadDataLastGames:', error);
        $("#last-games-container").html('<div class="error-message">Error loading last games: ' + error.message + '</div>');
    }
}

/* ---------- LOAD RANKINGS DATA ---------- */
async function loadDataRankings(teamId) {
    console.log('Loading rankings for team:', teamId);
    
    $("#rankings-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading rankings...</div></div>');
    
    try {
        let rankingsData;
        
        if (teamId === 'all') {
            const { data: rankingsAll, error: rankingsError } = await supabaseClient
                .from('rankings_complete')
                .select('*');
            
            if (rankingsError) throw rankingsError;
            rankingsData = rankingsAll;
        } else {
            const { data: rankingsTeam, error: rankingsError } = await supabaseClient
                .from('rankings_complete')
                .select('*')
                .eq('wiedikon_team_id', teamId);
            
            if (rankingsError) throw rankingsError;
            rankingsData = rankingsTeam;
        }
        
        // Render rankings
        renderRankings(rankingsData, teamId);
        
    } catch (error) {
        console.error('Error in loadDataRankings:', error);
        $("#rankings-container").html('<div class="error-message">Error loading rankings: ' + error.message + '</div>');
    }
}

/* ---------- MAIN DATA LOADER ---------- */
async function loadData(teamId) {
    console.log('Loading data for team:', teamId);
    
    // Show loading states
    $("#next-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading next games...</div></div>');
    $("#last-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading last games...</div></div>');
    $("#results-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading results...</div></div>');
    $("#rankings-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading rankings...</div></div>');
    
    try {
        // Load all data in parallel
        await Promise.all([
            loadDataNextGames(teamId),
            loadDataLastGames(teamId),
            loadDataResults(teamId),
            loadDataRankings(teamId)
        ]);
        
        // Update the last updated time (get from any of the data sources)
        let lastUpdated;
        try {
            const { data: sampleData } = await supabaseClient
                .from('rankings_complete')
                .select('updated_at')
                .limit(1);
            
            if (sampleData && sampleData.length > 0) {
                lastUpdated = sampleData[0].updated_at;
            }
        } catch (e) {
            console.warn('Could not fetch last updated time:', e);
        }
        
        if (lastUpdated) {
            $("#last-updated-time").text(formatLastUpdated(lastUpdated));
        } else {
            $("#last-updated-time").text("Unknown");
        }
        
    } catch (error) {
        console.error('Error in loadData:', error);
        const errorMessage = '<div class="error-message">Error loading data: ' + error.message + '</div>';
        $("#next-games-container").html(errorMessage);
        $("#last-games-container").html(errorMessage);
        $("#results-container").html(errorMessage);
        $("#rankings-container").html(errorMessage);
    }
}

/* ---------- POPULATE TEAM DROPDOWN ---------- */
async function populateTeamDropdown() {
    try {
        // Fetch all rankings data to get team names and group captions
        const { data: rankingsData, error } = await supabaseClient
            .from('rankings_complete')
            .select('wiedikon_team_id, teamcaption, group_caption')
            .not('wiedikon_team_id', 'is', null);
        
        if (error) throw error;
        
        // Create a map of team ID to team info
        const teamMap = {};
        rankingsData.forEach(rank => {
            if (rank.wiedikon_team_id && rank.teamcaption && rank.group_caption) {
                teamMap[rank.wiedikon_team_id] = {
                    name: rank.teamcaption,
                    group: rank.group_caption
                };
            }
        });
        
        // Sort teams alphabetically by name
        const sortedTeams = Object.entries(teamMap).sort((a, b) => 
            a[1].name.localeCompare(b[1].name)
        );
        
        // Populate dropdown
        const selector = $('#team-selector');
        selector.find('option:not(:first)').remove(); // Remove old options except "All Teams"
        
        sortedTeams.forEach(([teamId, teamInfo]) => {
            const option = `<option value="${teamId}">${teamInfo.name} - ${teamInfo.group}</option>`;
            selector.append(option);
        });
        
    } catch (error) {
        console.error('Error populating team dropdown:', error);
    }
}

/* ---------- POPULATE TEAM DROPDOWN ---------- */
async function populateTeamDropdown() {
    try {
        // Fetch all rankings data to get league captions for Wiedikon teams
        const { data: rankingsData, error } = await supabaseClient
            .from('rankings_complete')
            .select('*');
        
        if (error) throw error;
        
        // Filter for Wiedikon teams and get unique team data
        const wiedikonTeams = [];
        const seenTeams = new Set();
        
        rankingsData.forEach(ranking => {
            if (ranking.teamcaption && ranking.teamcaption.includes('Wiedikon') && !seenTeams.has(ranking.wiedikon_team_id)) {
                seenTeams.add(ranking.wiedikon_team_id);
                wiedikonTeams.push({
                    id: ranking.wiedikon_team_id,
                    name: ranking.teamcaption,
                    league: ranking.league_caption || 'Unknown League',
                    group: ranking.group_caption || 'Unknown Group'
                });
            }
        });
        
        // Sort teams alphabetically by name
        wiedikonTeams.sort((a, b) => a.name.localeCompare(b.name));
        
        // Populate dropdown
        const teamSelector = $('#team-selector');
        teamSelector.find('option:not(:first)').remove(); // Remove old options except "All Teams"
        
        wiedikonTeams.forEach(team => {
            // Extract team identifier (H1, D2, etc.) from team name
            const teamMatch = team.name.match(/KSC Wiedikon\s+(.+)/);
            const teamId = teamMatch ? teamMatch[1] : team.name;
            
            // Extract group letter (A, B, C, etc.) from group caption
            let groupLetter = '';
            if (team.group && team.group.length > 0) {
                // Only show groups for actual A, B, C groups, not for other identifiers like "M"
                const groupMatch = team.group.match(/\b([ABC])\b/);
                if (groupMatch) {
                    groupLetter = groupMatch[1];
                }
            }
            
            // Create option text: "KSCW H1 - 3L M Group A" format
            let optionText = `KSCW ${teamId}`;
            if (team.league) {
                optionText += ` - ${team.league}`;
                if (groupLetter) {
                    optionText += ` Group ${groupLetter}`;
                }
            }
            
            // Add sex (M or D) if available
            if (team.sex) {
                optionText += ` (${team.sex})`;
            }
            
            teamSelector.append(`<option value="${team.id}">${optionText}</option>`);
        });
        
    } catch (error) {
        console.error('Error populating team dropdown:', error);
    }
}

/* ---------- CACHE BUSTING ---------- */
function forceReload() {
    // Clear any cached data
    if (window.caches) {
        caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
        });
    }
    
    // Force reload the page
    window.location.reload(true);
}

/* ---------- INITIALIZATION ---------- */
$(function() {
    // Automatically clear cache and force reload on page load
    if (window.caches) {
        caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
        });
    }
    
    // Set up chip click handlers
    $('.chip').on('click', function() {
        const tabName = $(this).data('tab');
        switchTab(tabName);
    });
    
    // Set up team selector change handler
    $('#team-selector').on('change', function() {
        const selectedTeam = $(this).val();
        if (selectedTeam) {
            loadData(selectedTeam);
        } else {
            // Reset all containers
            $("#next-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Select a team to view next games</div></div>');
            $("#last-games-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Select a team to view last games</div></div>');
            $("#results-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Select a team to view results</div></div>');
            $("#rankings-container").html('<div class="loading-container"><div class="spinner"></div><div class="loading-text">Select a team to view rankings</div></div>');
        }
    });
    
    // Populate team dropdown first, then load data
    populateTeamDropdown().then(() => {
        // Auto-select "All Teams" on load
        $('#team-selector').val('all');
        loadData('all');
        
        // Try to auto-select team from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const teamParam = urlParams.get('team');
        if (teamParam) {
            $('#team-selector').val(teamParam);
            loadData(teamParam);
        }
    });
});
</script>