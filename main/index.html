<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Upcoming Volleyball Games</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap');
    * { box-sizing: border-box; }
    body { font-family: 'Aptos', sans-serif; margin:0; padding:0; background:#f0f4f8; color:#2d3748; line-height:1.6; }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    .header { text-align:center; margin-bottom:40px; background:white; border-radius:12px; padding:30px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h1 { margin:0; font-size:2.2rem; font-weight:600; }
    .block-selector { text-align:center; margin-bottom:30px; }
    .block-selector select { padding:10px 16px; font-size:16px; font-weight:500; border:2px solid #e2e8f0; border-radius:8px; background:white; cursor:pointer; min-width:180px; }
    .content-section { background:white; border-radius:12px; padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .content-section h2 { margin:0 0 20px; font-size:1.6rem; font-weight:600; }
    .sub-section h3 { margin:1.5em 0 0.5em; font-size:1.25rem; font-weight:500; }
    .table-wrapper { overflow-x:auto; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    table.dataTable { width:100% !important; font-size:12px; border-collapse:separate; border-spacing:0; border-radius:12px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    table.dataTable thead th { background:#1e40af; color:white; font-weight:600; padding:12px 8px; text-align:left; font-size:11px; text-transform:uppercase; }
    table.dataTable tbody td { padding:10px 8px; border-bottom:1px solid #e2e8f0; transition:background-color .2s; }
    table.dataTable tbody tr:last-child td { border-bottom:none; }
    table.dataTable tbody tr:nth-child(even) { background-color: #f8f9fa; }
    .error-message { color:#c53030; background:#fed7d7; padding:16px; border-radius:12px; margin:20px 0; border-left:4px solid #e53e3e; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Upcoming Volleyball Games</h1>
    </div>

    <div class="content-section">
      <h2>Next Fixtures</h2>
      <div class="block-selector">
        <label for="block-selector" style="margin-right:8px;font-weight:500;">Show next</label>
        <select id="block-selector">
          <option value="5" selected>5 dates</option>
          <option value="10">10 dates</option>
          <option value="15">15 dates</option>
          <option value="20">20 dates</option>
        </select>
      </div>
      <div id="results-container"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    const RESULTS_API = "https://volley-results-n72zsqdqea-oa.a.run.app";

    function formatDate(d) {
      const dt = new Date(d);
      if (isNaN(dt)) return d || "";
      const pad = n => n.toString().padStart(2,"0");
      return `${pad(dt.getDate())}.${pad(dt.getMonth()+1)}.${dt.getFullYear().toString().slice(-2)}`;
    }

    function formatTime(d) {
      const dt = new Date(d);
      if (isNaN(dt)) return d || "";
      const pad = n => n.toString().padStart(2,"0");
      return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }

    async function loadNextGames() {
      let resp = await fetch(`${RESULTS_API}/results`);
      if (!resp.ok) {
        $("#results-container").html(`<div class="error-message">Failed to load upcoming games</div>`);
        return;
      }
      const resultsData = await resp.json();
      const now = new Date();
      // filter out past games & sort
      const upcoming = resultsData
        .filter(r => new Date(r.playDate) >= now)
        .sort((a, b) => new Date(a.playDate) - new Date(b.playDate));

      // determine first N distinct dates
      const N = parseInt($("#block-selector").val(), 10) || 5;
      const seenDates = new Set();
      for (const game of upcoming) {
        const dateKey = new Date(game.playDate).toISOString().split("T")[0];
        if (seenDates.size < N) seenDates.add(dateKey);
        else break;
      }

      // keep all games on those dates
      const filtered = upcoming.filter(game =>
        seenDates.has(new Date(game.playDate).toISOString().split("T")[0])
      );

      // render table
      $("#results-container").empty();
      const $sec = $(`
        <div class="sub-section">
          <h3>Next ${seenDates.size} date block(s)</h3>
          <div class="table-wrapper"><table class="display"></table></div>
        </div>`);
      $("#results-container").append($sec);
      $sec.find("table").DataTable({
        data: filtered,
        columns: [
          { data: "playDate",      title: "Date",      render: (d,t) => t==="display" ? formatDate(d) : d },
          { data: "playDate",      title: "Time",      render: (d,t) => t==="display" ? formatTime(d) : d },
          { data: null,            title: "Match",     render: (_,__,r) => `${r.teams_home_caption} â€“ ${r.teams_away_caption}` },
          { data: "hall_caption",  title: "Halle" },
          { data: "hall_city",     title: "City" },
          { data: "hall_plusCode", title: "Plus Code", render: d => d ? `<a href="https://maps.google.com/?q=${d}" target="_blank">${d}</a>` : "" },
          { data: "referees",      title: "Referee(s)" },
          { data: "resultSummary", title: "Result",    render: d => Array.isArray(d) ? d.join(", ") : d }
        ],
        paging: false,
        ordering: false,
        info: false,
        searching: false
      });
    }

    $(function() {
      loadNextGames();
      $("#block-selector").change(loadNextGames);
    });
  </script>
</body>
</html>
